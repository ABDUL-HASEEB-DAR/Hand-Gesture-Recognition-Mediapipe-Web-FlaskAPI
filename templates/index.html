<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Hand Gesture Control</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        text-align: center;
        background: #292929;
        color: #000000;
        padding: 20px;
      }
      video,
      canvas {
        transform: scaleX(-1);
        border-radius: 20px;
        box-shadow: 0 4px 12px rgba(212, 212, 212, 0.651);
        margin: 10px;
      }
      #gestures {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        width: 90%;
        max-width: 800px;
      }
      .gesture-box {
        height: 100px;
        border: 2px solid #d8d8d8;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        transition: all 0.3s ease;
        border-radius: 10px;
        background: white;
      }
      .gesture-box span {
        font-size: 1.5em;
      }
      .active {
        background-color: #98ff98;
        color: rgb(0, 0, 0);
        box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4);
        transform: scale(1.1);
      }
      #main {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
      }
      .heading {
        color: #ffffff;
      }
      p {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <h1 class="heading">Gesture-Controlled Robot V-1.2</h1>
    <div id="main">
      <video
        id="video"
        width="640"
        height="480"
        autoplay
        muted
        playsinline
        style="display: none"
      ></video>
      <canvas id="canvas" width="640" height="480"></canvas>
      <div id="gestures">
        <div id="gesture-0" class="gesture-box">
          <span>🖐</span>
          <div>Open</div>
          <p>Move Forward</p>
        </div>
        <div id="gesture-1" class="gesture-box">
          <span>✊</span>
          <div>Close</div>
          <p>Move Backward</p>
        </div>
        <div id="gesture-2" class="gesture-box">
          <span>👆</span>
          <div>Pointer</div>
          <p>Rotate</p>
        </div>
        <div id="gesture-3" class="gesture-box">
          <span>👉</span>
          <div>Point Right</div>
          <p>Move Right</p>
        </div>
        <div id="gesture-4" class="gesture-box">
          <span>👈</span>
          <div>Point Left</div>
          <p>Move Left</p>
        </div>
        <div id="gesture-5" class="gesture-box">
          <span>👍</span>
          <div>Thumbs Up</div>
          <p>Elbow Up</p>
        </div>
        <div id="gesture-6" class="gesture-box">
          <span>👎</span>
          <div>Thumbs Down</div>
          <p>Elbow Down</p>
        </div>
        <div id="gesture-7" class="gesture-box">
          <span>🤏</span>
          <div>Pinch Open</div>
          <p>Claw Open</p>
        </div>
        <div id="gesture-8" class="gesture-box">
          <span>🤏</span>
          <div>Pinch Close</div>
          <p>Claw Close</p>
        </div>
        <div id="gesture-9" class="gesture-box">
          <span>✌</span>
          <div>Peace</div>
          <p>Base Rotate Left</p>
        </div>
        <div id="gesture-10" class="gesture-box">
          <span>🤘</span>
          <div>Rock</div>
          <p>Base Rotate Right</p>
        </div>
        <div id="gesture-11" class="gesture-box">
          <span>👆</span>
          <div>2-fingers point-up</div>
          <p>Shoulder Up</p>
        </div>
        <div id="gesture-12" class="gesture-box">
          <span>👇</span>
          <div>2-fingers point-down</div>
          <p>Shoulder Down</p>
        </div>
      </div>
    </div>

    <script>
      const socket = new WebSocket("ws://127.0.0.1:5000/ws");
      // const socket = new WebSocket(
      //   "wss://hand-gesture-recognition-mediapipe-web.onrender.com/ws"
      // );
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");
      const username = prompt("Enter your username") || "Unknown";

      socket.addEventListener("open", () => {
        socket.send(JSON.stringify({ type: "join", username }));
      });

      socket.addEventListener("message", (event) => {
        const data = JSON.parse(event.data);
        if (data && typeof data.prediction !== "undefined") {
          updateGestureBoxes(data.prediction);
        }
      });

      const gestureBoxes = document.querySelectorAll(".gesture-box");
      function updateGestureBoxes(prediction) {
        gestureBoxes.forEach((box) => box.classList.remove("active"));
        if (
          prediction !== null &&
          prediction >= 0 &&
          prediction < gestureBoxes.length
        ) {
          const box = document.getElementById(`gesture-${prediction}`);
          if (box) box.classList.add("active");
        }
      }

      function calcLandmarkList(image, landmarks) {
        const imageWidth = image.width;
        const imageHeight = image.height;
        return landmarks.map((lm) => [
          Math.min(Math.floor(lm.x * imageWidth), imageWidth - 1),
          Math.min(Math.floor(lm.y * imageHeight), imageHeight - 1),
        ]);
      }

      function preProcessLandmark(landmarkList) {
        let baseX = landmarkList[0][0];
        let baseY = landmarkList[0][1];
        let relCoords = landmarkList
          .map(([x, y]) => [x - baseX, y - baseY])
          .flat();
        const maxVal = Math.max(...relCoords.map(Math.abs)) || 1;
        return relCoords.map((v) => v / maxVal);
      }

      function sendMessage(landmark) {
        if (socket.readyState === WebSocket.OPEN && landmark) {
          socket.send(JSON.stringify({ type: "gesture", landmarks: landmark }));
        }
      }

      async function onResults(results) {
        ctx.save();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
        if (
          results.multiHandLandmarks &&
          results.multiHandLandmarks.length > 0
        ) {
          const landmarks = results.multiHandLandmarks[0];
          drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {
            color: "#0f0",
            lineWidth: 2,
          });
          drawLandmarks(ctx, landmarks, { color: "#f00", lineWidth: 1 });

          const landmarkList = calcLandmarkList(canvas, landmarks);
          const processed = preProcessLandmark(landmarkList);
          sendMessage(processed);
        } else {
          updateGestureBoxes(null);
        }
        ctx.restore();
      }

      const hands = new Hands({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
      });

      hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7,
      });

      hands.onResults(onResults);

      const camera = new Camera(video, {
        onFrame: async () => await hands.send({ image: video }),
        width: 640,
        height: 480,
      });

      camera.start();
    </script>
  </body>
</html>
